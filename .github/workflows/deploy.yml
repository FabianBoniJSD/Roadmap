name: Build and Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Build and deploy on self-hosted
    runs-on: [self-hosted, windows]
    env:
      NEXT_TELEMETRY_DISABLED: '1'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Show disk space (before)
        run: |
          Write-Output "Disk space before:"
          Get-PSDrive C | Select-Object Used,Free

      - name: Free up disk space (caches, logs, artifacts)
        run: |
          # Clean NPM cache
          npm cache clean --force
          # Remove PM2 logs if present
          if (Test-Path "$env:USERPROFILE\.pm2\logs") {
            Remove-Item -Path "$env:USERPROFILE\.pm2\logs\*" -Force -ErrorAction SilentlyContinue
          }
          # Remove previous local artifacts if present
          if (Test-Path "node_modules") { Remove-Item -Path "node_modules" -Recurse -Force -ErrorAction SilentlyContinue }
          if (Test-Path ".next") { Remove-Item -Path ".next" -Recurse -Force -ErrorAction SilentlyContinue }
          Write-Output "Freed space."
      
      - name: Show disk space (after cleanup)
        run: |
          Write-Output "Disk space after cleanup:"
          Get-PSDrive C | Select-Object Used,Free

      - name: Install dependencies
        run: npm ci

      - name: Build application
        env:
          NODE_ENV: production
          # GitHub Secrets for multi-user authentication
          # Format: USER_<name> with value <username>:<password>
          # All users automatically have admin rights
          USER_FABIAN: ${{ secrets.USER_FABIAN }}
          USER_STEFAN: ${{ secrets.USER_STEFAN }}
          USER_ADMIN: ${{ secrets.USER_ADMIN }}
          # Add more USER_* secrets as needed
        run: npm run build

      - name: Verify Next.js build output exists
        run: |
          if (-not (Test-Path ".next")) {
            Write-Error "Error: .next build directory not found. Build likely failed."
            exit 1
          }
          Write-Output "Found .next directory."

      - name: Set PM2 HOME
        run: |
          $env:PM2_HOME = "$env:USERPROFILE\.pm2"
          echo "PM2_HOME=$env:PM2_HOME" >> $env:GITHUB_ENV

      - name: Install PM2 (process manager)
        run: npm install -g pm2

      - name: Stop existing instance (if any)
        run: |
          # First try to stop PM2 process gracefully
          Write-Output "Attempting to stop PM2 process..."
          pm2 stop roadmap-app 2>$null
          Start-Sleep -Seconds 2
          pm2 delete roadmap-app 2>$null
          Start-Sleep -Seconds 2
          
          # Force kill any remaining process on port 3000 (try multiple times if needed)
          Write-Output "Checking for processes on port 3000..."
          $maxKillAttempts = 3
          for ($i = 1; $i -le $maxKillAttempts; $i++) {
            $connections = Get-NetTCPConnection -LocalPort 3000 -ErrorAction SilentlyContinue
            if (-not $connections) {
              Write-Output "Port 3000 is free"
              break
            }
            
            Write-Output "Kill attempt $i/$maxKillAttempts..."
            $processes = $connections | Select-Object -ExpandProperty OwningProcess -Unique
            foreach ($processId in $processes) {
              Write-Output "  Force killing process $processId"
              try {
                Stop-Process -Id $processId -Force -ErrorAction Stop
              } catch {
                Write-Output "  Warning: Failed to kill process $processId - $_"
              }
            }
            
            if ($i -lt $maxKillAttempts) {
              Start-Sleep -Seconds 5
            }
          }
          
          # Final verification - if still in use, try taskkill
          $finalCheck = Get-NetTCPConnection -LocalPort 3000 -ErrorAction SilentlyContinue
          if ($finalCheck) {
            Write-Output "Port still in use, trying taskkill..."
            $processes = $finalCheck | Select-Object -ExpandProperty OwningProcess -Unique
            foreach ($processId in $processes) {
              Write-Output "  Using taskkill on process $processId"
              taskkill /F /PID $processId 2>$null
            }
            Start-Sleep -Seconds 3
          }
          
          # Final check
          $check = Get-NetTCPConnection -LocalPort 3000 -ErrorAction SilentlyContinue
          if ($check) {
            Write-Output "WARNING: Port 3000 is still in use after all attempts"
            netstat -ano | Select-String ":3000"
            Write-Output "Continuing anyway - PM2 may be able to restart using a different approach"
          } else {
            Write-Output "SUCCESS: Port 3000 is now free"
          }
        continue-on-error: true

      - name: Start app on port 3000 with PM2
        env:
          NODE_ENV: production
          PORT: 3000
          # GitHub Secrets for multi-user authentication
          USER_FABIAN: ${{ secrets.USER_FABIAN }}
          USER_STEFAN: ${{ secrets.USER_STEFAN }}
          USER_ADMIN: ${{ secrets.USER_ADMIN }}
        run: |
          Write-Output "Starting roadmap-app with PM2..."
          
          # Check if app already exists in PM2
          $pmList = pm2 list | Out-String
          if ($pmList -match "roadmap-app") {
            Write-Output "App exists in PM2, using reload..."
            pm2 reload ecosystem.config.js --update-env
          } else {
            Write-Output "App doesn't exist in PM2, starting fresh..."
            pm2 start ecosystem.config.js
          }
          
          Start-Sleep -Seconds 5
          Write-Output "Waiting for app to initialize..."

      - name: Save PM2 process list
        run: pm2 save

      - name: Show PM2 status and recent logs
        run: |
          pm2 status
          pm2 describe roadmap-app
          Write-Output "`nRecent logs:"
          pm2 logs roadmap-app --lines 100 --nostream
          Write-Output "`nChecking port 3000..."
          netstat -ano | Select-String ":3000"

      - name: Ensure app is online
        run: |
          Write-Output "Checking if app is online..."
          
          # Wait up to 60 seconds for app to be online
          $maxAttempts = 12
          $attempt = 0
          $isOnline = $false
          
          while ($attempt -lt $maxAttempts -and -not $isOnline) {
            $attempt++
            Write-Output "Health check attempt $attempt/$maxAttempts..."
            
            # Show current PM2 status
            pm2 list
            
            $pmStatus = pm2 list | Out-String
            if ($pmStatus -match "roadmap-app.*online") {
              $isOnline = $true
              Write-Output "✓ App is online under PM2!"
              break
            }
            
            # Check for error states
            if ($pmStatus -match "roadmap-app.*(errored|stopped|stopping)") {
              Write-Output "⚠ App is in error state, showing logs..."
              pm2 logs roadmap-app --lines 50 --nostream
            }
            
            if ($attempt -lt $maxAttempts) {
              Write-Output "App not online yet, waiting 5 seconds..."
              Start-Sleep -Seconds 5
            }
          }
          
          if (-not $isOnline) {
            Write-Output "⚠ PM2 reports app is not 'online', checking HTTP endpoint..."
            
            # Try HTTP health check
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:3000" -TimeoutSec 5 -UseBasicParsing
              if ($response.StatusCode -eq 200) {
                Write-Output "✓ HTTP endpoint is responding (status 200)!"
                Write-Output "PM2 may be showing a different status, but app is working."
                $isOnline = $true
              }
            } catch {
              Write-Output "✗ HTTP endpoint also not responding: $_"
            }
          }
          
          if (-not $isOnline) {
            Write-Error "✗ App failed to come online after $maxAttempts attempts"
            Write-Output "`nFinal PM2 status:"
            pm2 status
            Write-Output "`nFull PM2 describe:"
            pm2 describe roadmap-app
            Write-Output "`nRecent logs:"
            pm2 logs roadmap-app --lines 200 --nostream
            Write-Output "`nPort check:"
            netstat -ano | Select-String ":3000"
            exit 1
          } else {
            Write-Output "`n✓✓✓ Deployment successful! ✓✓✓"
          }
